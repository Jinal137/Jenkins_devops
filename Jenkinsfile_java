pipeline {
    agent {label 'node1' }

    environment {
        REMOTE_HOST = 'jenkins@192.168.29.92'
        JAVA_FILE = 'Hello.java'
        REMOTE_PATH = '/home/jenkins'
    }

    stages {
    
    	stage('Clone') {
            steps {
            	git url: 'https://github.com/Jinal137/Java.git', branch: 'master'
            }
        }
        stage('Apache Tomcat Installation') {
            steps {
                script {
                    def tomcatDir = "/opt/tomcat"
                    def checkTomcatCmd = "if [ ! -d ${tomcatDir} ]; then echo 'not_installed'; else echo 'installed'; fi"

                    def result = sh(script: "ssh ${REMOTE_HOST} '${checkTomcatCmd}'", returnStdout: true).trim()

                    if (result == 'not_installed') {
                        
                        sh '''
                            	 ssh ${REMOTE_HOST}
                                wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.76/bin/apache-tomcat-9.0.96.tar.gz
// Make it Env variables
// Add echo if not installed
// Create Service to start tomcat
                                tar -xvzf apache-tomcat-9.0.96.tar.gz
                                sudo mv apache-tomcat-9.0.96 /opt/tomcat
                                sudo chown -R jenkins:jenkins /opt/tomcat
                                /opt/tomcat/bin/startup.sh
                           
                        '''
                        echo 'Apache Tomcat is now installed.'
                    } else {
                        echo 'Apache Tomcat is already installed.'
                    }
                }
            }
        }

        stage('Compile Java File') {
            steps {
                script {

                    sh '''
                            ssh ${REMOTE_HOST} '
                            mkdir -p ${REMOTE_PATH}/J_Java/webapp/WEB-INF/classes
                            sudo chown -R jenkins:jenkins ${REMOTE_PATH}/J_Java
                            '
                           scp ${JAVA_FILE} ${REMOTE_HOST}:${REMOTE_PATH}/J_Java/
                    '''
                }
            }
        }

        stage('WAR File') {
            steps {
                script {
                    sh '''
                            ssh ${REMOTE_HOST} '
                            cd ${REMOTE_PATH}/J_Java
                            javac -cp "/opt/tomcat/lib/servlet-api.jar" ${JAVA_FILE}
                            echo "cp ${REMOTE_PATH}/J_Java/Hello.class webapp/WEB-INF/classes/"
                            cp ${REMOTE_PATH}/J_Java/Hello.class webapp/WEB-INF/classes/
                            cd ${REMOTE_PATH}/J_Java/webapp
                            jar -cvf ../helloworld.war * '
                    '''
                }
            }
        }
    }
}
