pipeline {
    agent {label 'node1' }

    environment {
        REMOTE_HOST = 'jenkins@192.168.29.92'
        JAVA_FILE = 'Hello.java'
        REMOTE_PATH = '/home/jenkins'
    }

    stages {
    
    	stage('Clone') {
            steps {
            	git url: 'https://github.com/Jinal137/Java.git', branch: 'master'
            }
        }
        stage('Apache Tomcat Installation') {
            steps {
                script {
                    def tomcatDir = "/opt/tomcat"
                    def checkTomcatCmd = "if [ ! -d ${tomcatDir} ]; then echo 'not_installed'; else echo 'installed'; fi"

                    def result = sh(script: "ssh ${REMOTE_HOST} '${checkTomcatCmd}'", returnStdout: true).trim()

                    if (result == 'not_installed') {
                        
                        sh '''
                            	 ssh ${REMOTE_HOST}
                                wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.76/bin/apache-tomcat-9.0.96.tar.gz
// Make it Env variables
// Add echo if not installed
// Create Service to start tomcat
                                tar -xvzf apache-tomcat-9.0.96.tar.gz
                                sudo mv apache-tomcat-9.0.96 /opt/tomcat
                                sudo chown -R jenkins:jenkins /opt/tomcat
                           
                        '''
                        echo 'Apache Tomcat is now installed.'
                    } else {
                        echo 'Apache Tomcat is already installed.'
                    }
                }
            }
        }
        stage('Create Tomcat Service') {
            steps {
                script {
                    def serviceCheckCmd = "systemctl is-active tomcat"
                    def serviceExists = sh(script: "ssh ${REMOTE_HOST} '${serviceCheckCmd}'", returnStatus: true)

                    if (serviceExists != 0) { // Service does not exist
                        sh """
                            ssh ${REMOTE_HOST} '
                            sudo nano /etc/systemd/system/tomcat.service
                            echo "[Unit]
                            Description=Apache Tomcat Web Application Container
                            After=network.target

                            [Service]
                            Type=simple
                            User=jenkins  # Change to the user that runs Tomcat
                            Group=jenkins  # Change to the appropriate group
                            Environment=JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64  # Update as necessary
                            Environment=CATALINA_HOME=/opt/tomcat
                            Environment=CATALINA_BASE=/opt/tomcat
                            ExecStart=/opt/tomcat/bin/startup.sh
                            ExecStop=/opt/tomcat/bin/shutdown.sh
                            RestartSec=10
                            Restart=always

                            [Install]
                            WantedBy=multi-user.target" | sudo tee /etc/systemd/system/tomcat.service

                            # Reload systemd daemon and enable the Tomcat service
                            sudo systemctl daemon-reload
                            sudo systemctl enable tomcat
                            sudo systemctl start tomcat
                            '
                        """
                        echo 'Tomcat service created and started.'
                    } else {
                        echo 'Tomcat service already exists.'
                    }
                }
            }
        }

        stage('Compile Java File') {
            steps {
                script {

                    sh '''
                            ssh ${REMOTE_HOST} '
                            mkdir -p J_Java/webapp/WEB-INF/classes
                            sudo chown -R jenkins:jenkins J_Java
                            '
                          
                    '''
                }
            }
        }

        stage('WAR File') {
            steps {
                script {
                    sh """
                    	     scp ${JAVA_FILE} ${REMOTE_HOST}:${REMOTE_PATH}/J_Java/
                            ssh ${REMOTE_HOST} '''
                            cd ${REMOTE_PATH}/J_Java
                            pwd
                            javac -cp "/opt/tomcat/lib/servlet-api.jar" ${JAVA_FILE}
                            echo "cp Hello.class webapp/WEB-INF/classes/"
                            cp Hello.class webapp/WEB-INF/classes/
                            cd webapp
                            jar -cvf ../hellojinal.war * 
                            pwd
                            cp ${REMOTE_PATH}/J_Java/hellojinal.war /opt/tomcat/webapps/
                            '''

                    """
                }
            }
        }
    }
}
